#!/usr/bin/env python3
"""
Markdown ç”Ÿæˆå™¨ - è‡ªåŠ¨åˆ›å»ºä¸­è‹±æ–‡ç‰ˆæœ¬æ–‡æ¡£
"""

import os
from pathlib import Path
from datetime import datetime
import re

class MarkdownGenerator:
    def __init__(self, repo_base_url="https://github.com/Angelagoodboy/KK_Archive"):
        """
        åˆå§‹åŒ–ç”Ÿæˆå™¨
        
        Args:
            repo_base_url: é¡¹ç›®åŸºç¡€URLï¼ˆç”¨äºç”Ÿæˆä¸­æ–‡ç‰ˆé“¾æ¥ï¼‰
        """
        self.repo_base_url = repo_base_url.rstrip('/')
        
    def generate_pair(self, content: str, title: str, 
                     original_url: str = "", publish_date: str = "",
                     output_dir: str = "."):
        """
        ç”Ÿæˆä¸­è‹±æ–‡Markdownæ–‡ä»¶å¯¹
        
        Args:
            content: åŸå§‹æ–‡æœ¬å†…å®¹
            title: æ–‡æ¡£æ ‡é¢˜
            original_url: åŸæ–‡URLï¼ˆå¯é€‰ï¼‰
            publish_date: å‘å¸ƒæ—¥æœŸï¼ˆå¯é€‰ï¼‰
            output_dir: è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰
        """
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        output_path = Path(output_dir)
        output_path.mkdir(exist_ok=True)
        
        # ç”Ÿæˆè‹±æ–‡ç‰ˆ
        en_md = self._generate_en_version(content, title, original_url, publish_date)
        en_filename = f"{self._sanitize_filename(title)}.md"
        en_filepath = output_path / en_filename
        
        # ç”Ÿæˆä¸­æ–‡ç‰ˆ
        cn_md = self._generate_cn_version(en_md, title)
        cn_filename = f"{self._sanitize_filename(title)}_cn.md"
        cn_filepath = output_path / cn_filename
        
        # å†™å…¥æ–‡ä»¶
        with open(en_filepath, 'w', encoding='utf-8') as f:
            f.write(en_md)
        
        with open(cn_filepath, 'w', encoding='utf-8') as f:
            f.write(cn_md)
        
        print(f"âœ… æ–‡ä»¶ç”Ÿæˆå®Œæˆ:")
        print(f"   â€¢ è‹±æ–‡ç‰ˆ: {en_filepath}")
        print(f"   â€¢ ä¸­æ–‡ç‰ˆ: {cn_filepath}")
        print(f"   â€¢ ä¸­æ–‡ç‰ˆURL: {self._generate_cn_url(title)}")
        
        return en_filepath, cn_filepath
    
    def _generate_en_version(self, content: str, title: str, 
                           original_url: str, publish_date: str) -> str:
        """ç”Ÿæˆè‹±æ–‡ç‰ˆMarkdown"""
        if not publish_date:
            publish_date = datetime.now().strftime("%Y-%m-%d")
        
        metadata = self._build_metadata_block(original_url, publish_date, title)
        
        return f"""# {title}

{metadata}

{content}

---

*Document generated by KK Document Processor*
"""

    def _generate_cn_version(self, en_content: str, title: str) -> str:
        """ç”Ÿæˆä¸­æ–‡ç‰ˆMarkdownï¼ˆæ¨¡æ‹Ÿç¿»è¯‘ï¼‰"""
        # è¿™é‡Œåº”è¯¥è°ƒç”¨ç¿»è¯‘APIï¼Œæš‚æ—¶ç”¨ç®€å•æ›¿æ¢æ¨¡æ‹Ÿ
        cn_title = f"{title}ï¼ˆä¸­æ–‡ç‰ˆï¼‰"
        
        # æ¨¡æ‹Ÿç¿»è¯‘å†…å®¹
        cn_content = en_content.replace("Document generated by", "æ–‡æ¡£ç”±").replace("KK Document Processor", "KKæ–‡æ¡£å¤„ç†å™¨ç”Ÿæˆ")
        
        return f"""# {cn_title}

{cn_content}
"""

    def _build_metadata_block(self, original_url: str, 
                            publish_date: str, title: str) -> str:
        """æ„å»ºå…ƒæ•°æ®å—"""
        cn_url = self._generate_cn_url(title)
        
        lines = [
            "**Document Information**",
            f"- Original URL: {original_url}" if original_url else "- Original URL: Not provided",
            f"- Publish Date: {publish_date}",
            f"- Chinese Version: [{cn_url}]({cn_url})"
        ]
        return '\n'.join(lines)
    
    def _generate_cn_url(self, title: str) -> str:
        """ç”Ÿæˆä¸­æ–‡ç‰ˆURL"""
        cn_filename = f"{self._sanitize_filename(title)}_cn.md"
        return f"{self.repo_base_url}/blob/main/{cn_filename}"
    
    def _sanitize_filename(self, filename: str) -> str:
        """æ¸…ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦"""
        return re.sub(r'[\\/*?:"<>|]', "", filename).replace(" ", "_")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    print("ğŸ¦Š KK Markdown Generator")
    print("=" * 50)
    
    # ç¤ºä¾‹å†…å®¹
    sample_content = """This is a sample document content. 
It contains multiple paragraphs that will be formatted into Markdown.

## Section 1
- Item 1
- Item 2

## Section 2
Main content goes here..."""
    
    generator = MarkdownGenerator()
    
    # ç”Ÿæˆä¸­è‹±æ–‡æ–‡æ¡£å¯¹
    generator.generate_pair(
        content=sample_content,
        title="Sample Document",
        original_url="https://example.com/original",
        publish_date="2024-01-01",
        output_dir="output_docs"
    )